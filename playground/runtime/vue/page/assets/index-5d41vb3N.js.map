{"version":3,"file":"index-5d41vb3N.js","sources":["../../../../../packages/utils/src/dom.ts","../../../../../node_modules/.pnpm/@tmagic+vue-page@0.2.1_@tmagic+core@1.6.0_typescript@5.9.2__@tmagic+vue-runtime-help@1._0c0ae0503bc0f6064ac4718f1030ebe1/node_modules/@tmagic/vue-page/src/index.vue"],"sourcesContent":["export const asyncLoadJs = (() => {\n  // 正在加载或加载成功的存入此Map中\n  const documentMap = new Map();\n\n  return (url: string, crossOrigin?: string, document = globalThis.document) => {\n    let loaded = documentMap.get(document);\n    if (!loaded) {\n      loaded = new Map();\n      documentMap.set(document, loaded);\n    }\n\n    // 正在加载或已经加载成功的，直接返回\n    if (loaded.get(url)) return loaded.get(url);\n\n    const load = new Promise<void>((resolve, reject) => {\n      const script = document.createElement('script');\n      script.type = 'text/javascript';\n      if (crossOrigin) {\n        script.crossOrigin = crossOrigin;\n      }\n      script.src = url;\n      document.body.appendChild(script);\n      script.onload = () => {\n        resolve();\n      };\n      script.onerror = () => {\n        reject(new Error('加载失败'));\n      };\n      setTimeout(() => {\n        reject(new Error('timeout'));\n      }, 60 * 1000);\n    }).catch((err) => {\n      // 加载失败的，从map中移除，第二次加载时，可以再次执行加载\n      loaded.delete(url);\n      throw err;\n    });\n\n    loaded.set(url, load);\n    return loaded.get(url);\n  };\n})();\n\nexport const asyncLoadCss = (() => {\n  // 正在加载或加载成功的存入此Map中\n  const documentMap = new Map();\n\n  return (url: string, document = globalThis.document) => {\n    let loaded = documentMap.get(document);\n    if (!loaded) {\n      loaded = new Map();\n      documentMap.set(document, loaded);\n    }\n\n    // 正在加载或已经加载成功的，直接返回\n    if (loaded.get(url)) return loaded.get(url);\n\n    const load = new Promise<void>((resolve, reject) => {\n      const node = document.createElement('link');\n      node.rel = 'stylesheet';\n      node.href = url;\n      document.head.appendChild(node);\n      node.onload = () => {\n        resolve();\n      };\n      node.onerror = () => {\n        reject(new Error('加载失败'));\n      };\n      setTimeout(() => {\n        reject(new Error('timeout'));\n      }, 60 * 1000);\n    }).catch((err) => {\n      // 加载失败的，从map中移除，第二次加载时，可以再次执行加载\n      loaded.delete(url);\n      throw err;\n    });\n\n    loaded.set(url, load);\n    return loaded.get(url);\n  };\n})();\n\nexport const addClassName = (el: Element, doc: Document, className: string) => {\n  const oldEl = doc.querySelector(`.${className}`);\n  if (oldEl && oldEl !== el) removeClassName(oldEl, className);\n  if (!el.classList.contains(className)) el.classList.add(className);\n};\n\nexport const removeClassName = (el: Element, ...className: string[]) => {\n  el.classList.remove(...className);\n};\n\nexport const removeClassNameByClassName = (doc: Document, className: string) => {\n  const el: HTMLElement | null = doc.querySelector(`.${className}`);\n  el?.classList.remove(className);\n  return el;\n};\n\nexport const injectStyle = (doc: Document, style: string) => {\n  const styleEl = doc.createElement('style');\n  styleEl.innerHTML = style;\n  doc.head.appendChild(styleEl);\n  return styleEl;\n};\n\nexport const createDiv = ({ className, cssText }: { className: string; cssText: string }) => {\n  const el = globalThis.document.createElement('div');\n  el.className = className;\n  el.style.cssText = cssText;\n  return el;\n};\n\nexport const getDocument = () => globalThis.document;\n\nexport const calcValueByFontsize = (doc: Document | undefined, value: number) => {\n  if (!doc) return value;\n  const { fontSize } = doc.documentElement.style;\n\n  if (fontSize) {\n    const times = globalThis.parseFloat(fontSize) / 100;\n    return Number((value / times).toFixed(2));\n  }\n\n  return value;\n};\n\nconst dslDomRelateConfig = {\n  getIdFromEl: (el?: HTMLElement | SVGElement | null) => el?.dataset?.tmagicId,\n  getElById: (doc?: Document, id?: string | number) => doc?.querySelector(`[data-tmagic-id=\"${id}\"]`) as HTMLElement,\n  setIdToEl: (el: HTMLElement | SVGElement, id: string | number) => {\n    el.dataset.tmagicId = `${id}`;\n  },\n};\n\nexport const setDslDomRelateConfig = <\n  K extends keyof typeof dslDomRelateConfig,\n  T extends (typeof dslDomRelateConfig)[K],\n>(\n  name: K,\n  value: T,\n) => {\n  dslDomRelateConfig[name] = value;\n};\n\nexport const getIdFromEl = () => dslDomRelateConfig.getIdFromEl;\n\nexport const getElById = () => dslDomRelateConfig.getElById;\n\nexport const setIdToEl = () => dslDomRelateConfig.setIdToEl;\n","<template>\n  <component\n    :is=\"containerComponent\"\n    :class=\"className\"\n    :style=\"style\"\n    :data-tmagic-id=\"config.id\"\n    :config=\"{ ...config, [IS_DSL_NODE_KEY]: false }\"\n  ></component>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent, inject, nextTick, type PropType, watch } from 'vue-demi';\n\nimport type TMagicApp from '@tmagic/core';\nimport { asyncLoadCss, asyncLoadJs, IS_DSL_NODE_KEY, type MPage } from '@tmagic/core';\nimport { useComponent, useComponentStatus, useNode } from '@tmagic/vue-runtime-help';\n\nconst createCss = (config: MPage) => {\n  if (config.cssFile) {\n    asyncLoadCss(config.cssFile);\n  }\n\n  if (Array.isArray(config.cssFiles)) {\n    config.cssFiles.map((file) => asyncLoadCss(file.url));\n  }\n\n  if (config.css) {\n    const style = window.document.createElement('style');\n    style.innerHTML = config.css;\n    window.document.head.appendChild(style);\n  }\n};\n\nconst createJs = (config: MPage) => {\n  if (Array.isArray(config.jsFiles)) {\n    config.jsFiles.map((file) => asyncLoadJs(file.url));\n  }\n};\n\nexport default defineComponent({\n  name: 'tmagic-page',\n\n  props: {\n    config: {\n      type: Object as PropType<MPage>,\n      required: true,\n    },\n    model: {\n      type: Object,\n      default: () => ({}),\n    },\n  },\n\n  setup(props) {\n    const app = inject<TMagicApp>('app');\n\n    if (app?.jsEngine === 'browser') {\n      createCss(props.config);\n      createJs(props.config);\n    }\n\n    const containerComponent = useComponent({ componentType: 'container', app });\n\n    const { style, className } = useComponentStatus(props);\n\n    const refresh = () => {\n      window.location.reload();\n    };\n\n    watch(\n      () => props.config,\n      async (config, preConfig) => {\n        const node = useNode({ config: { ...config, [IS_DSL_NODE_KEY]: true } }, app);\n\n        if (config.id !== preConfig?.id) {\n          node?.setInstance({ config: props.config, refresh });\n          node?.emit('created');\n        }\n        await nextTick();\n\n        if (config.id !== preConfig?.id) {\n          node?.emit('mounted');\n          const preNode = useNode({ config: { ...preConfig, [IS_DSL_NODE_KEY]: true } }, app);\n          preNode?.emit('destroy');\n        }\n      },\n      {\n        immediate: true,\n      },\n    );\n\n    return {\n      style,\n      className,\n      containerComponent,\n      IS_DSL_NODE_KEY,\n    };\n  },\n});\n</script>\n"],"names":["asyncLoadJs","documentMap","url","crossOrigin","document","loaded","load","resolve","reject","script","err","asyncLoadCss","node","createCss","config","file","style","createJs","_sfc_main","defineComponent","props","app","inject","containerComponent","useComponent","className","useComponentStatus","refresh","watch","preConfig","useNode","IS_DSL_NODE_KEY","nextTick","preNode","_openBlock","_createBlock","_resolveDynamicComponent","_ctx","_normalizeClass","_normalizeStyle"],"mappings":"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","x_google_ignoreList":[1]}